<!DOCTYPE html>
<html lang="en">

<head>
	<title>TP3 - Tristan Delapierre</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="stylesheet" href="css/basic.css">

	<script src="three.js"></script>
	<script src="js/Detector.js"></script>
	<script src="js/FlyControls.js"></script>
	<script type="text/javascript">

		// Checks that your browser supports WebGL. 
		if (!Detector.webgl) Detector.addGetWebGLMessage();

		var renderer = null;
		var scene = null;
		var camera = null;
		var curTime = Date.now();

		var solarSystem = null;
		var earthGroup = null;
		var moonGroup = null;
		var sun = null;
		var earth = null;
		var moon = null;
		var sunLight = null;

		var controls = null;

		// This function is called whenever the document is loaded
		function init() {
			// Get display canvas
			var canvas = document.getElementById("webglcanvas");
			console.log(canvas);

			// Create the Three.js renderer and attach it to our canvas
			renderer = new THREE.WebGLRenderer({
				canvas: canvas,
				antialias: true
			});
			// Set the viewport size
			renderer.setSize(canvas.width, canvas.height);
			document.body.appendChild( renderer.domElement );
			// Create a new Three.js scene
			scene = new THREE.Scene();
			// Add  a camera so we can view the scene
			camera = new THREE.PerspectiveCamera(45, canvas.width / canvas.height, 1, 4000);

			controls = new THREE.FlyControls(camera, renderer.domElement);
			
			var mapEarth = new THREE.TextureLoader().load("images/earth_atmos_2048.jpg");
			var mapMoon = new THREE.TextureLoader().load("images/moon_1024.jpg");
			var earthSpec = new THREE.TextureLoader().load("images/earth_specular_2048.jpg");
			var earthEmissive = new THREE.TextureLoader().load("images/earth_lights_2048.jpg");

			var earthNormal = new THREE.TextureLoader().load("images/earth_normal_2048.jpg");

			var earthMaterial = new THREE.MeshPhongMaterial({ map: mapEarth, normalMap: earthNormal, specularMap: earthSpec, emissiveMap: earthEmissive, emissive: 0xffffff});
			var moonMaterial = new THREE.MeshPhongMaterial({ map: mapMoon });
			var sunMaterial = new THREE.MeshBasicMaterial({ color: 0xFFFF00 });

			var geometrySun = new THREE.SphereGeometry(2, 256, 256);
			var geometryEarth = new THREE.SphereGeometry(1, 128, 128);
			var geometryMoon = new THREE.SphereGeometry(0.3, 128, 128);

			solarSystem = new THREE.Group();
			earthGroup = new THREE.Group();
			moonGroup = new THREE.Group();
			sun = new THREE.Mesh(geometrySun, sunMaterial)
			earth = new THREE.Mesh(geometryEarth, earthMaterial);
			moon = new THREE.Mesh(geometryMoon, moonMaterial);

			moonGroup.add(moon);

			earthGroup.add(earth);
			earthGroup.add(moonGroup);

			solarSystem.add(sun);
			solarSystem.add(earthGroup);

			earth.position.x = 9;
			moon.position.z = 2;

			sunLight = new THREE.PointLight(0xffffff, 1.5);
			sunLight.position.x = solarSystem.position.x;
			sunLight.position.y = solarSystem.position.y;
			sunLight.position.z = solarSystem.position.z;

			// Finally, add the mesh to our scene
			scene.add(solarSystem);
			scene.add(sunLight);
			camera.position.z = 5;
		}

		// This function is called regularly to update the canvas webgl.
		function run() {
			// Ask to call again run 
			requestAnimationFrame(run);

			// Render the scene
			render();

			// Calls the animate function if objects or camera should move
			animate();
		}

		// This function is called regularly to take care of the rendering.
		function render() {
			// Render the scene
			renderer.render(scene, camera);
		}

		// This function is called regularly to update objects.
		function animate() {


			// Computes how time has changed since last display
			var now = Date.now();
			var deltaTime = now - curTime;
			curTime = now;
			var fracTime = deltaTime / 1000 / 50; // in seconds
			// Now we can move objects, camera, etc.
			// Example: rotation cube
			var angle = fracTime * Math.PI * 2;
			// Notez que l'axe y est l'axe "vertical" usuellement.
			earthGroup.rotation.y += angle / 365;// la terre tourne en 365 jours
			earth.rotation.y += angle; // et en un jour sur elle-même
			moonGroup.rotation.y += angle / 28; // la lune tourne en 28 jours autour de la terre
			moon.rotation.y += angle / 28; // et en 28 jours aussi sur elle-même pour faire face à la terre
			moonGroup.position.x = earth.position.x;
			moonGroup.position.y = earth.position.y;
			moonGroup.position.z = earth.position.z;

			controls.update(deltaTime / 1000);
		}

	</script>
</head>

<body>
	<div id="info"> TP3 - Tristan Delapierre </div>
	<canvas id="webglcanvas" style="border: none;background-color:#000000" width="1600" height="900"></canvas>
	<!-- We run the WebGL code at the end to be sure that the document is loaded.
      -->
	<script>
		init(); run();
	</script>
</body>

</html>